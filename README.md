Утилита для извлечения пар СНИЛС + Фамилия из структуры каталогов с файлами.

## Описание

Проект содержит два скрипта для извлечения данных СНИЛС и фамилий:

### 1. extract_snils_surnames.py (Универсальный экстрактор)

Комплексный инструмент, который сканирует структуру каталогов и извлекает пары "СНИЛС + Фамилия" из:
- Имен файлов (первое кириллическое слово, похожее на фамилию)
- Excel файлов с именем "Персональные данные.xlsx" (ячейка B2, первое слово как фамилия)
- Каталогов с именами в формате 11-значного СНИЛС

Также создается список всех найденных СНИЛС, включая те, для которых не удалось определить фамилию.

### 2. extract_personal_data_from_xlsx.py (Специализированный Excel-экстрактор)

Специализированный инструмент для работы только с Excel файлами "Персональные данные.xlsx":
- Извлекает СНИЛС из ячейки B1
- Извлекает фамилию из ячейки B2 (первое слово из ФИО)
- Работает исключительно с содержимым Excel файлов
- Не анализирует структуру папок или имена файлов

## Особенности

### extract_snils_surnames.py
- **Обнаружение СНИЛС**: Поиск 11-значных номеров в путях файлов, именах файлов и каталогах
- **Извлечение фамилий**: Умное определение фамилий из кириллических слов с исключением медицинских терминов
- **Поддержка Excel**: Чтение ячейки B2 из файлов "Персональные данные.xlsx"
- **Фильтрация**: Автоматическое исключение медицинских терминов (Антропометрия, Маммография и др.)
- **Обработка каталогов**: Сканирование каталогов с именами в формате СНИЛС
- **Дедупликация**: Автоматическое удаление дубликатов
- **Полный охват**: Включение СНИЛС без фамилий в итоговый список
- **Сортировка**: Результаты отсортированы по СНИЛС, затем по фамилии

### extract_personal_data_from_xlsx.py
- **Точное извлечение**: Читает СНИЛС из ячейки B1 и ФИО из ячейки B2
- **Валидация СНИЛС**: Автоматическая очистка от нецифровых символов и проверка длины
- **Простота**: Работает только с точным названием файла "Персональные данные.xlsx"
- **Производительность**: Оптимизирован для массовой обработки Excel файлов
- **Надежность**: Обработка ошибок при чтении поврежденных файлов

## Установка

1. Клонировать репозиторий:
```bash
git clone <repository-url>
cd dispa
```

2. Установить зависимости:
```bash
pip install -r requirements.txt
```

## Использование

### Универсальный экстрактор (extract_snils_surnames.py)

#### Базовое использование

```bash
python scripts/extract_snils_surnames.py
```

Сканирует текущий каталог и создает файлы в папке `scripts/`:
- `scripts/all_paths.txt` - список всех найденных файлов
- `scripts/snils_surnames.txt` - пары СНИЛС + Фамилия и отдельные СНИЛС

#### Расширенное использование

```bash
python scripts/extract_snils_surnames.py /path/to/scan --paths custom_paths.txt --out custom_results.txt
```

#### Параметры командной строки

- `ROOT_DIR` - Корневой каталог для сканирования (по умолчанию: текущий каталог)
- `--paths OUT1` - Файл для списка всех путей (по умолчанию: `scripts/all_paths.txt`)
- `--out OUT2` - Файл для результатов СНИЛС+Фамилия (по умолчанию: `scripts/snils_surnames.txt`)

### Специализированный Excel-экстрактор (extract_personal_data_from_xlsx.py)

#### Базовое использование

```bash
python scripts/extract_personal_data_from_xlsx.py
```

Сканирует текущий каталог в поисках файлов "Персональные данные.xlsx" и создает файл `scripts/snils_surnames.txt`.

#### Расширенное использование

```bash
python scripts/extract_personal_data_from_xlsx.py /path/to/scan --out custom_results.txt
```

#### Параметры командной строки

- `ROOT_DIR` - Корневой каталог для сканирования (по умолчанию: текущий каталог)
- `--out OUT` - Файл для результатов СНИЛС+Фамилия (по умолчанию: `scripts/snils_surnames.txt`)

## Формат вывода

### extract_snils_surnames.py
Файл результатов содержит:
- СНИЛС с фамилиями (по одной паре на строку)
- СНИЛС без фамилий (только номер на строку)

Пример:
```
00892112570 Иванов
00891112570 Смирнов
05325487162 Сидоров
12345678901
98765432109
```

### extract_personal_data_from_xlsx.py
Файл результатов содержит только пары СНИЛС + фамилия (по одной паре на строку):

Пример:
```
00892112570 Иванов
00891112570 Смирнов
05325487162 Сидоров
```

## Алгоритм извлечения фамилий

### extract_snils_surnames.py (Универсальный подход)

1. **Из имен файлов**:
   - Поиск первого кириллического слова, за которым следует другое имя или инициалы
   - Предпочтение словам в ВЕРХНЕМ РЕГИСТРЕ или с Заглавной буквы
   - Минимальная длина: 3 символа
   - Исключение медицинских терминов и нежелательных записей

2. **Из Excel файлов**:
   - Чтение ячейки B2 из файлов "Персональные данные.xlsx"
   - Извлечение первого слова как фамилии

3. **Обработка каталогов**:
   - Автоматическое определение каталогов с именами в формате 11-значного СНИЛС
   - Включение всех найденных СНИЛС в итоговый список

### extract_personal_data_from_xlsx.py (Excel-специфичный подход)

1. **Поиск файлов**:
   - Поиск файлов с точным названием "Персональные данные.xlsx" (без учета регистра)
   - Рекурсивное сканирование всех подкаталогов

2. **Извлечение данных**:
   - **B1**: СНИЛС с автоматической очисткой от нецифровых символов
   - **B2**: ФИО, из которого берется первое слово как фамилия

3. **Валидация**:
   - СНИЛС должен содержать ровно 11 цифр
   - Фамилия должна быть непустой строкой

## Исключаемые термины

### extract_snils_surnames.py
Скрипт автоматически исключает следующие медицинские термины и нежелательные записи:
- Антропометрия
- Артериальное  
- Внутриглазное
- Маммография
- Персональные
- Рентгенография
- Электрокардиография
- Анкета
- Записи с СНИЛС "00000000000" (фальшивые номера)

### extract_personal_data_from_xlsx.py
Не применяет фильтрацию терминов, так как работает исключительно с структурированными данными из Excel.

## Требования

- Python 3.6+
- openpyxl (для работы с Excel файлами)

## Примеры структуры файлов

### Для extract_snils_surnames.py
Скрипт может обрабатывать такие структуры:
```
/data/
  12345678901/
    Иванов_И_И_документ.pdf
    Персональные данные.xlsx
  98765432109/
    ПЕТРОВА_А_В_справка.docx
```

Результат:
```
12345678901 Иванов
98765432109 Петрова
```

### Для extract_personal_data_from_xlsx.py
Скрипт ищет только файлы Excel с данными:
```
/data/
  Пациент1/
    Персональные данные.xlsx  (B1: 12345678901, B2: Иванов Иван Иванович)
  Пациент2/
    Персональные данные.xlsx  (B1: 98765432109, B2: Петрова Анна Викторовна)
```

Результат:
```
12345678901 Иванов
98765432109 Петрова
```

## Дополнительные возможности

### Работа с виртуальными средами Python

Оба скрипта могут работать в виртуальной среде Python:

1. Создание виртуальной среды:
```bash
python -m venv .venv
```

2. Активация (Windows):
```bash
.venv\Scripts\activate
```

3. Установка зависимостей:
```bash
pip install -r requirements.txt
```

4. Запуск скриптов:
```bash
python scripts/extract_snils_surnames.py
python scripts/extract_personal_data_from_xlsx.py
```

### Мониторинг выполнения

#### extract_snils_surnames.py
Скрипт выводит информационные сообщения о ходе выполнения:
- Количество найденных каталогов СНИЛС
- Предупреждения об отсутствующих зависимостях
- Количество обработанных файлов и извлеченных пар

#### extract_personal_data_from_xlsx.py
Скрипт выводит:
- Количество найденных Excel файлов
- Количество успешно извлеченных записей
- Ошибки при отсутствии библиотеки openpyxl

### Выбор подходящего скрипта

**Используйте extract_snils_surnames.py когда:**
- Нужно извлечь максимум данных из разных источников
- Структура файлов неоднородная
- Требуется анализ имен файлов и каталогов
- Нужен список всех найденных СНИЛС (даже без фамилий)

**Используйте extract_personal_data_from_xlsx.py когда:**
- Данные хранятся исключительно в Excel файлах
- Нужна высокая скорость обработки
- Требуется точность извлечения из конкретных ячеек
- Структура Excel файлов стандартизована

## Замечания

### extract_snils_surnames.py
- Если библиотека `openpyxl` не установлена, извлечение из Excel файлов будет пропущено с предупреждением
- СНИЛС определяется как последовательность из ровно 11 цифр
- Поддерживаются файлы с расширениями .xlsx и .xslx (учитывая возможные опечатки)
- Выходные файлы создаются в папке `scripts/` относительно местоположения скрипта
- Автоматически исключаются записи с фальшивыми СНИЛС (все нули)
- Медицинские термины и другие нежелательные записи исключаются из результатов

### extract_personal_data_from_xlsx.py
- Требует обязательной установки библиотеки `openpyxl`
- Работает только с файлами, имеющими точное название "Персональные данные.xlsx"
- Не выполняет дедупликацию результатов (записывает все найденные пары)
- СНИЛС автоматически очищается от нецифровых символов
- Обрабатывает ошибки чтения поврежденных Excel файлов
- Более производительный для массовой обработки однотипных Excel файлов

## Сравнение скриптов

| Характеристика | extract_snils_surnames.py | extract_personal_data_from_xlsx.py |
|----------------|---------------------------|-----------------------------------|
| **Источники данных** | Имена файлов, каталогов, Excel B2 | Только Excel B1 и B2 |
| **Поиск СНИЛС** | В путях, именах файлов, каталогах | Только в ячейке B1 |
| **Извлечение фамилий** | Умный анализ текста + Excel B2 | Только из Excel B2 |
| **Фильтрация** | Исключает медицинские термины | Нет фильтрации |
| **Дедупликация** | Автоматическая | Нет |
| **Файлы без фамилий** | Включает СНИЛС без фамилий | Только пары |
| **Производительность** | Средняя (комплексный анализ) | Высокая (простое чтение) |
| **Гибкость** | Высокая | Низкая (только Excel) |
| **Надежность** | Работает без openpyxl | Требует openpyxl |
| **Рекомендуется для** | Смешанных структур данных | Стандартизированных Excel |
