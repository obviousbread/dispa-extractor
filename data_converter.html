<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ –°–ù–ò–õ–°/–ï–ù–ü</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É SheetJS –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .button-group {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .verify-btn {
            background-color: #28a745;
        }
        
        .verify-btn:hover {
            background-color: #218838;
        }
        
        .copy-btn {
            background-color: #17a2b8;
        }
        
        .copy-btn:hover {
            background-color: #138496;
        }
        
        .export-btn {
            background-color: #fd7e14;
        }
        
        .export-btn:hover {
            background-color: #e8650e;
        }
        
        .duplicate-btn {
            background-color: #6f42c1;
        }
        
        .duplicate-btn:hover {
            background-color: #5a32a3;
        }
        
        .clear-btn {
            background-color: #6c757d;
        }
        
        .clear-btn:hover {
            background-color: #545b62;
        }
        
        .result-container {
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e9ecef;
        }
        
        .status-checking {
            color: #007bff;
        }
        
        .status-found {
            color: #28a745;
        }
        
        .status-error {
            color: #dc3545;
        }
        
        .status-not-found {
            color: #ffc107;
        }
        
        .duplicate-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }
        
        .duplicate-group {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .duplicate-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #6f42c1;
        }
        
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .info {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .example {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }
        
        .example h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        .stats {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        
        .verification-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ –°–ù–ò–õ–°/–ï–ù–ü</h1>
        
        <div class="example">
            <h3>–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:</h3>
            <pre>01459093225    –°–∏–¥–æ—Ä–æ–≤
02347711234    –ò–≤–∞–Ω–æ–≤
115-171-030 38    –ò–≤–∞–Ω–æ–≤
125-473-857 75    –°–∏–¥–æ—Ä–æ–≤
7750520882001336    –ü–µ—Ç—Ä–æ–≤–∞
4756430891000166    –°–º–∏—Ä–Ω–æ–≤–∞
01453013215, –°–∏–¥–æ—Ä–æ–≤–∞
02347723234,–ò–≤–∞–Ω–æ–≤–∞
02347743234 ,–°–º–∏—Ä–Ω–æ–≤–∞
02347713234   ;          –°–∏–¥–æ—Ä–æ–≤–∞
7750520232001336, –ò–≤–∞–Ω–æ–≤–∞
4756420431000166,–°–∏–¥–æ—Ä–æ–≤–∞
2814123456 –ò–≤–∞–Ω–æ–≤
2814 123456 –ò–≤–∞–Ω–æ–≤
14184234157 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á 04.10.2000</pre>
            <p><strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong></p>
            <ul>
                <li><strong>–°–ù–ò–õ–°</strong> (11 —Ü–∏—Ñ—Ä) –∏ —Ñ–∞–º–∏–ª–∏—è —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ —Ç–∞–±—É–ª—è—Ü–∏—é</li>
                <li><strong>–ï–ù–ü</strong> (16 —Ü–∏—Ñ—Ä) –∏ —Ñ–∞–º–∏–ª–∏—è —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ —Ç–∞–±—É–ª—è—Ü–∏—é</li>
                <li><strong>–ü–∞—Å–ø–æ—Ä—Ç –†–§</strong> (10 —Ü–∏—Ñ—Ä: —Å–µ—Ä–∏—è 4 —Ü–∏—Ñ—Ä—ã + –Ω–æ–º–µ—Ä 6 —Ü–∏—Ñ—Ä) –∏ —Ñ–∞–º–∏–ª–∏—è</li>
                <li>–°–ù–ò–õ–° –≤ —Ñ–æ—Ä–º–∞—Ç–µ xxx-xxx-xxx xx –∏ —Ñ–∞–º–∏–ª–∏—è</li>
                <li>–ü–∞—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ xxxx xxxxxx –∏ —Ñ–∞–º–∏–ª–∏—è</li>
                <li>–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ñ–∞–º–∏–ª–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏–ª–∏ –±–µ–∑)</li>
                <li>–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ñ–∞–º–∏–ª–∏—è —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π</li>
                <li>–°—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –Ω–æ–º–µ—Ä–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Ñ–∞–º–∏–ª–∏—è –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π)</li>
                <li><strong>–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</strong> - –∏–∑ —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞ "–°–ù–ò–õ–° –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ –î–∞—Ç–∞" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –°–ù–ò–õ–° –∏ —Ñ–∞–º–∏–ª–∏—è</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ü–∏—Ñ—Ä</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å –§–ï–†–ó</li>
                <div><b>–ü—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É –ë–ï–ó –£–ö–ê–ó–ê–ù–ò–Ø —Ñ–∞–º–∏–ª–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ "–ù–µ —É–∫–∞–∑–∞–Ω–æ" –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–∞—Ü–∏–µ–Ω—Ç—É –Ω–∞–π–¥–µ–Ω—ã –ù–ï –ë–£–î–£–¢. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –§–ï–†–ó</b></div>
            </ul>
        </div>
        
        <div class="form-group">
            <label for="dataInput">–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:</label>
            <textarea id="dataInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –°–ù–ò–õ–°/–ï–ù–ü/–ü–∞—Å–ø–æ—Ä—Ç —Ñ–∞–º–∏–ª–∏—è"></textarea>
        </div>
        
        <div class="button-group">
            <button onclick="convertToTable()">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É</button>
            <button class="verify-btn" onclick="verifyAllData()" disabled id="verifyBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –§–ï–†–ó</button>
            <button class="copy-btn" onclick="copyTableData()" disabled id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã</button>
            <button class="export-btn" onclick="exportToExcel()" disabled id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
            <button class="duplicate-btn" onclick="checkDuplicates()" disabled id="duplicateBtn">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
            <button class="clear-btn" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
        
        <div class="verification-controls" id="verificationControls" style="display: none;">
            <h4>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏:</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div id="progressText">–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
            <button onclick="stopVerification()" id="stopBtn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
        </div>
        
        <div id="resultContainer" class="result-container"></div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let globalData = [];
        let verificationInProgress = false;
        let currentVerificationIndex = 0;
        let shouldStopVerification = false;
        
        // –§—É–Ω–∫—Ü–∏–∏ –∏–∑ search.html –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –§–ï–†–ó
        function createXmlHttpRequest() {
            var xmlhttp;
            try {
                xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
            }
            catch (e) {
                try {
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                }
                catch (E) {
                    xmlhttp = false;
                }
            }
            if (!xmlhttp && typeof XMLHttpRequest != 'undefined') {
                xmlhttp = new XMLHttpRequest();
            }
            return xmlhttp;
        }
        
        function Request(opts) {
            var MODE_XDR = 1;
            var MODE_XHR = 2;
            return {
                url: opts.url,
                data: opts.data,
                on_success: opts.onSuccess,
                on_error: opts.onError,
                on_abort: opts.onAbort,
                hr_mode: undefined,
                hr: null,

                go: function () {
                    var that = this;
                    if (!!window.XDomainRequest) {
                        that.hr_mode = MODE_XDR;
                        that.hr = new window.XDomainRequest();
                    }
                    else {
                        that.hr_mode = MODE_XHR;
                        that.hr = createXmlHttpRequest();
                    }
                    var hr = that.hr;
                    try {
                        if ('onload' in hr && 'onerror' in hr) {
                            hr.onload = function () {
                                if (!('status' in hr)) {
                                    that.on_success(hr.responseText);
                                }
                                else {
                                    if (hr.status === 200) {
                                        that.on_success(hr.responseText);
                                    }
                                    else {
                                        var msg = (hr.status || '') + ' ' + (hr.statusText || '');
                                        that.on_error(msg);
                                    }
                                }
                            }
                            hr.onerror = function (e) {
                                var msg = (hr.status || '') + ' ' + (hr.statusText || '');
                                that.on_error(msg.replace(' ', ''));
                            }
                            if (hr.onabort)
                                hr.onabort = function () { that.on_abort(); }
                        }
                        else {
                            hr.onreadystatechange = function () {
                                if (hr.readyState === 4) {
                                    if (hr.status === 200) {
                                        that.on_success(hr.responseText);
                                    }
                                    else {
                                        console.log("Caught non-200 response " + hr.status + ' ' + hr.statusText);
                                        that.on_error(hr.status + ' ' + hr.statusText);
                                    }
                                }
                            }
                        }
                        //
                        hr.open('POST', that.url, true);
                        if ('setRequestHeader' in hr)
                            hr.setRequestHeader('CONTENT-TYPE', 'application/soap+xml;charset=UTF-8');
                        window.setTimeout(function () { hr.send(that.data); }, 1);
                    }
                    catch (e) {
                        that.on_error(e.message || e.what);
                    }
                },
                abort: function () {
                    var that = this;
                    that.hr && that.hr.abort();
                    if (!that.hr.onabort)
                        that.on_abort();
                },
            };
        }
        
        function buildSoapMessageForFed(login, psw, fam, doc, doc_type, msg_id) {
            var vers = '3';
            var ns = 'https://support.arhofoms.ru/ws/people-search/xsd';
            var env = '<?xml version="1.0" encoding="utf-8"?>\n\
                <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" \n\
                xmlns:v1="https://support.arhofoms.ru/ws/svc/xsd/v1-request" \n\
                xmlns:xsd="'+ ns + '">\n\
           <soap:Header>\n\
              <v1:message-id>'+ msg_id + '</v1:message-id>\n\
              <v1:tag><client>tfoms-client-fed</client></v1:tag>\n\
              <v1:auth>\n\
                  <v1:username>'+ login + '</v1:username>\n\
                  <v1:password>'+ psw + '</v1:password>\n\
              </v1:auth>\n\
           </soap:Header>';

            env += '<soap:Body><xsd:FindPersonFed_v'+vers+'_request> \n\
                                <surname>'+ fam + '</surname> \n\
                                <doc_num>'+ doc + '</doc_num> \n\
                                <doc_type>'+ doc_type + '</doc_type> \n\
                             </xsd:FindPersonFed_v'+vers+'_request> \n\
                             </soap:Body>\n';
            env += '</soap:Envelope>';

            return env;
        }
        
        function genUUIDv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function parseXmlResponse(xml_val) {
            if (!xml_val || xml_val.replace(/^\s+|\s+$/g, '').length === 0)
                return { error: "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞" };

            var xml, parser;
            if (window.DOMParser) {
                parser = new DOMParser();
                xml = parser.parseFromString(xml_val, "text/xml");
            } else {
                xml = new ActiveXObject("Microsoft.XMLDOM");
                xml.async = false;
                xml.loadXML(xml_val);
            }
            
            var errorCount = xml.getElementsByTagNameNS("http://www.w3.org/2003/05/soap-envelope", "Fault").length;
            if (errorCount !== 0) {
                var err_text = xml.getElementsByTagNameNS("http://www.w3.org/2003/05/soap-envelope", "Text")[0].textContent;
                return { error: err_text };
            }
            
            try {
                var ter_str = xml.getElementsByTagName("ter_str")[0].childNodes[0].nodeValue;
                var smo_name = xml.getElementsByTagName('smo')[0].childNodes[0].nodeValue;
                var enp = xml.getElementsByTagName('enp')[0].childNodes[0].nodeValue;
                var date_begin = xml.getElementsByTagName('date_begin')[0].childNodes[0].nodeValue;
                var date_close = (xml.getElementsByTagName('date_close').length === 0) ? '' : xml.getElementsByTagName('date_close')[0].childNodes[0].nodeValue;
                var policy_type = xml.getElementsByTagName('policy_type')[0].childNodes[0].nodeValue;
                var pol_ser_num = xml.getElementsByTagName('policy_series_number')[0];
                var policy_series_number = pol_ser_num.childNodes.length ? pol_ser_num.childNodes[0].nodeValue : "";
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
                if (date_begin && date_begin.length > 0) {
                    const day = date_begin.toString().slice(-2);
                    const month = date_begin.toString().slice(5, 7);
                    const year = date_begin.toString().slice(0, 4);
                    date_begin = `${day}.${month}.${year}`;
                }
                
                if (date_close && date_close.length > 0) {
                    const dayC = date_close.toString().slice(-2);
                    const monthC = date_close.toString().slice(5, 7);
                    const yearC = date_close.toString().slice(0, 4);
                    date_close = `${dayC}.${monthC}.${yearC}`;
                }
                
                // –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–π
                var attachments = [];
                var att_list = xml.getElementsByTagName('attachments')[0];
                if (att_list) {
                    for (var ia = 0; ia < att_list.childNodes.length; ++ia) {
                        var a = att_list.childNodes[ia];
                        var att = {};
                        for (var n = 0; n < a.childNodes.length; ++n) {
                            var nn = a.childNodes[n].nodeName;
                            var nv = a.childNodes[n].childNodes[0].nodeValue;
                            att[nn] = nv;
                        }
                        attachments.push(att);
                    }
                }
                
                var attachment_info = '';
                if (attachments.length > 0) {
                    attachment_info = attachments.map(function(att) {
                        var info = '—Å ' + att.valid_from;
                        if (att.valid_till) info += ' –ø–æ ' + att.valid_till;
                        info += ' ' + att.code + ' ' + att.name;
                        return info;
                    }).join('; ');
                }
                
                return {
                    success: true,
                    ter_str: ter_str,
                    smo_name: smo_name,
                    enp: enp,
                    date_begin: date_begin,
                    date_close: date_close,
                    policy_type: policy_type,
                    policy_series_number: policy_series_number,
                    attachments: attachment_info
                };
            } catch (e) {
                return { error: "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: " + e.message };
            }
        }
        
        function convertToTable() {
            const input = document.getElementById('dataInput').value.trim();
            const resultContainer = document.getElementById('resultContainer');
            
            if (!input) {
                resultContainer.innerHTML = '<div class="error">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.</div>';
                return;
            }
            
            try {
                const lines = input.split('\n').filter(line => line.trim() !== '');
                const data = [];
                let errors = [];
                
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        const result = parseLineAdvanced(trimmedLine);
                        
                        if (result.error) {
                            errors.push(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: "${trimmedLine}" - ${result.error}`);
                        } else {
                            data.push({ 
                                docNumber: result.docNumber,
                                docType: result.docType,
                                surname: result.surname,
                                firstName: result.firstName || '',
                                middleName: result.middleName || '',
                                birthDate: result.birthDate || '',
                                status: '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω',
                                ter_str: '',
                                smo_name: '',
                                enp: '',
                                date_begin: '',
                                date_close: '',
                                policy_type: '',
                                policy_series_number: '',
                                attachments: ''
                            });
                        }
                    }
                });
                
                if (data.length === 0) {
                    resultContainer.innerHTML = '<div class="error">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.</div>';
                    return;
                }
                
                globalData = data;
                
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                let html = '';
                
                if (errors.length > 0) {
                    html += '<div class="error"><strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</strong><ul>';
                    errors.forEach(error => {
                        html += `<li>${error}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += `<div class="stats">
                    <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ ${lines.length} —Å—Ç—Ä–æ–∫
                </div>`;
                
                html += '<div class="table-container">';
                html += `
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–î–æ–∫—É–º–µ–Ω—Ç</th>
                            <th>–§–∞–º–∏–ª–∏—è</th>
                            <th>–ò–º—è</th>
                            <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è</th>
                            <th>–°–ú–û</th>
                            <th>–ï–ù–ü</th>
                            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>–¢–∏–ø –ø–æ–ª–∏—Å–∞</th>
                            <th>–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞</th>
                            <th>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                `;
                
                data.forEach((item, index) => {
                    html += `
                        <tr id="row-${index}">
                            <td>${index + 1}</td>
                            <td>${formatDocument(item.docNumber, item.docType)}</td>
                            <td>${item.surname || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>'}</td>
                            <td>${item.firstName || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–æ</em>'}</td>
                            <td>${item.middleName || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–æ</em>'}</td>
                            <td>${item.birthDate || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>'}</td>
                            <td class="status-column">${item.status}</td>
                            <td class="ter-str-column"></td>
                            <td class="smo-name-column"></td>
                            <td class="enp-column"></td>
                            <td class="date-begin-column"></td>
                            <td class="date-close-column"></td>
                            <td class="policy-type-column"></td>
                            <td class="policy-series-column"></td>
                            <td class="attachments-column"></td>
                        </tr>
                    `;
                });
                
                html += `
                    </tbody>
                </table>
                </div>
                `;
                
                resultContainer.innerHTML = html;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('duplicateBtn').disabled = false;
                
            } catch (error) {
                resultContainer.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
            }
        }
        
        // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
        function parseLineAdvanced(line) {
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            const trimmedLine = line.trim();
            
            if (!trimmedLine) {
                return { error: "–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞" };
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞)
            const docMatch = trimmedLine.match(/^(\d[\d\s\-]*\d|\d+)/);
            if (!docMatch) {
                return { error: "–ù–µ –Ω–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏" };
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            const docDigits = docMatch[0].match(/\d/g);
            
            if (!docDigits || docDigits.length < 10) {
                return { 
                    error: `–î–æ–∫—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 10 —Ü–∏—Ñ—Ä (–Ω–∞–π–¥–µ–Ω–æ ${docDigits ? docDigits.length : 0} —Ü–∏—Ñ—Ä)` 
                };
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä
            let docNumber, docType, digitCount;
            
            if (docDigits.length >= 16) {
                // 16 –∏–ª–∏ –±–æ–ª—å—à–µ —Ü–∏—Ñ—Ä - —ç—Ç–æ –ï–ù–ü
                docNumber = docDigits.slice(0, 16).join('');
                docType = 4; // –ï–ù–ü
                digitCount = 16;
            } else if (docDigits.length >= 11) {
                // –û—Ç 11 –¥–æ 15 —Ü–∏—Ñ—Ä - —ç—Ç–æ –°–ù–ò–õ–°
                docNumber = docDigits.slice(0, 11).join('');
                docType = 3; // –°–ù–ò–õ–°
                digitCount = 11;
            } else if (docDigits.length >= 10) {
                // 10 —Ü–∏—Ñ—Ä - —ç—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç –†–§ (—Å–µ—Ä–∏—è 4 —Ü–∏—Ñ—Ä—ã + –Ω–æ–º–µ—Ä 6 —Ü–∏—Ñ—Ä)
                docNumber = docDigits.slice(0, 10).join('');
                docType = 1; // –ü–∞—Å–ø–æ—Ä—Ç –†–§
                digitCount = 10;
            } else {
                return { 
                    error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ü–∏—Ñ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–π–¥–µ–Ω–æ ${docDigits.length} —Ü–∏—Ñ—Ä)` 
                };
            }
            
            // –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–∞–Ω–Ω—ã—Ö
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ
            // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–∏—Ñ—Ä –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
            let docEndPos = 0;
            let foundDigits = 0;
            
            for (let i = 0; i < trimmedLine.length; i++) {
                if (/\d/.test(trimmedLine[i])) {
                    foundDigits++;
                    if (foundDigits === digitCount) {
                        // –ù–∞–π–¥–µ–Ω—ã –≤—Å–µ —Ü–∏—Ñ—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∏—â–µ–º –ø–µ—Ä–≤—ã–π –Ω–µ—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –ø–æ—Å–ª–µ –Ω–∏—Ö
                        docEndPos = i + 1;
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                        while (docEndPos < trimmedLine.length && /[\s\-]/.test(trimmedLine[docEndPos])) {
                            docEndPos++;
                        }
                        break;
                    }
                } else if (foundDigits > 0 && !/[\s\-]/.test(trimmedLine[i])) {
                    // –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ –Ω–µ-—Ü–∏—Ñ—Ä—É –∏ –Ω–µ-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞ —Ü–∏—Ñ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞,
                    // –∑–Ω–∞—á–∏—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
                    break;
                }
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            let remainingText = trimmedLine.substring(docEndPos);
            
            // –û—á–∏—â–∞–µ–º –æ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –∏ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ
            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –ø—Ä–æ–±–µ–ª—ã, —Ç–∞–±—É–ª—è—Ü–∏—è, –∑–∞–ø—è—Ç–∞—è, —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π
            remainingText = remainingText.replace(/^[\s,;]+/, '').trim();
            
            // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å, –∏–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            let surname = '';
            let firstName = '';
            let middleName = '';
            let birthDate = '';
            
            if (remainingText) {
                // –†–∞–∑–±–∏–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
                const parts = remainingText.split(/\s+/);
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                let cyrillicWords = [];
                
                for (let part of parts) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∞—Å—Ç—å –¥–∞—Ç–æ–π (—Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY)
                    if (/^\d{2}\.\d{2}\.\d{4}$/.test(part)) {
                        birthDate = part;
                    } else if (/[–∞-—è—ë–ê-–Ø–Å]/.test(part)) {
                        cyrillicWords.push(part);
                    }
                }
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ –∏–∑ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏—Ö —Å–ª–æ–≤
                if (cyrillicWords.length >= 1) surname = cyrillicWords[0];
                if (cyrillicWords.length >= 2) firstName = cyrillicWords[1];
                if (cyrillicWords.length >= 3) middleName = cyrillicWords[2];
            }
            
            return {
                docNumber: docNumber,
                docType: docType,
                surname: surname,
                firstName: firstName,
                middleName: middleName,
                birthDate: birthDate
            };
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ—Ç–¥–µ–ª–µ–Ω—ã –ª–∏ —Ü–∏—Ñ—Ä—ã —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º
        function isDigitsSeparated(line, digitPosition) {
            let digitCount = 0;
            for (let i = 0; i < line.length; i++) {
                if (/\d/.test(line[i])) {
                    digitCount++;
                    if (digitCount === digitPosition) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–∏–º–≤–æ–ª –ø–æ—Å–ª–µ –Ω—É–∂–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        return i + 1 >= line.length || /[\s,;]/.test(line[i + 1]);
                    }
                }
            }
            return true;
        }
        
        function checkDuplicates() {
            if (globalData.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –°–ù–ò–õ–°
            const duplicateGroups = findDuplicates();
            
            if (duplicateGroups.length === 0) {
                showDuplicateResults([], 0);
                return;
            }
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
            highlightDuplicates(duplicateGroups);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            showDuplicateResults(duplicateGroups, getTotalDuplicateCount(duplicateGroups));
        }
        
        function findDuplicates() {
            const docGroups = {};
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
            globalData.forEach((item, index) => {
                const docNumber = item.docNumber;
                if (!docGroups[docNumber]) {
                    docGroups[docNumber] = [];
                }
                docGroups[docNumber].push({ ...item, originalIndex: index });
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ (–±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏)
            const duplicateGroups = [];
            Object.keys(docGroups).forEach(docNumber => {
                if (docGroups[docNumber].length > 1) {
                    duplicateGroups.push({
                        docNumber: docNumber,
                        docType: docGroups[docNumber][0].docType, // –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
                        records: docGroups[docNumber]
                    });
                }
            });
            
            return duplicateGroups;
        }
        
        function highlightDuplicates(duplicateGroups) {
            // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            document.querySelectorAll('.duplicate-row').forEach(row => {
                row.classList.remove('duplicate-row');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏
            duplicateGroups.forEach(group => {
                group.records.forEach(record => {
                    const row = document.getElementById(`row-${record.originalIndex}`);
                    if (row) {
                        row.classList.add('duplicate-row');
                    }
                });
            });
        }
        
        function getTotalDuplicateCount(duplicateGroups) {
            return duplicateGroups.reduce((total, group) => total + group.records.length, 0);
        }
        
        function showDuplicateResults(duplicateGroups, totalCount) {
            const resultContainer = document.getElementById('resultContainer');
            let duplicateHtml = '';
            
            if (duplicateGroups.length === 0) {
                duplicateHtml = `
                    <div class="duplicate-controls">
                        <h4>üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã</h4>
                        <div class="info">
                            <strong>–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!</strong><br>
                            –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã –ø–æ –°–ù–ò–õ–°.
                        </div>
                    </div>
                `;
            } else {
                duplicateHtml = `
                    <div class="duplicate-controls">
                        <h4>‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã</h4>
                        <div class="stats">
                            <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –ù–∞–π–¥–µ–Ω–æ ${duplicateGroups.length} –≥—Ä—É–ø–ø –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, 
                            –≤—Å–µ–≥–æ ${totalCount} –∑–∞–ø–∏—Å–µ–π (${totalCount - duplicateGroups.length} –ª–∏—à–Ω–∏—Ö)
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <button class="verify-btn" onclick="removeDuplicates()" style="margin-right: 10px;">
                                –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–µ)
                            </button>
                            <button class="clear-btn" onclick="clearDuplicateHighlight()">
                                –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            </button>
                        </div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                duplicateGroups.forEach((group, groupIndex) => {
                    const docTypeName = group.docType === 1 ? '–ü–∞—Å–ø–æ—Ä—Ç –†–§' : 
                                       group.docType === 3 ? '–°–ù–ò–õ–°' : '–ï–ù–ü';
                    duplicateHtml += `
                        <div class="duplicate-group">
                            <h5>–ì—Ä—É–ø–ø–∞ ${groupIndex + 1}: ${docTypeName} ${formatDocument(group.docNumber, group.docType)}</h5>
                            <table style="font-size: 11px; margin: 5px 0;">
                                <thead>
                                    <tr>
                                        <th>‚Ññ —Å—Ç—Ä–æ–∫–∏</th>
                                        <th>–§–∞–º–∏–ª–∏—è</th>
                                        <th>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    group.records.forEach((record, recordIndex) => {
                        const actionText = recordIndex === 0 ? '<strong>–û—Å—Ç–∞–≤–∏—Ç—å</strong>' : '–£–¥–∞–ª–∏—Ç—å';
                        const actionClass = recordIndex === 0 ? 'status-found' : 'status-error';
                        
                        duplicateHtml += `
                            <tr>
                                <td>${record.originalIndex + 1}</td>
                                <td>${record.surname || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>'}</td>
                                <td>${record.status || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'}</td>
                                <td class="${actionClass}">${actionText}</td>
                            </tr>
                        `;
                    });
                    
                    duplicateHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                duplicateHtml += `</div>`;
            }
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const existingTable = resultContainer.querySelector('.table-container');
            if (existingTable) {
                resultContainer.insertBefore(
                    document.createRange().createContextualFragment(duplicateHtml).firstElementChild,
                    existingTable
                );
            } else {
                resultContainer.innerHTML = duplicateHtml + resultContainer.innerHTML;
            }
        }
        
        function removeDuplicates() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.')) {
                return;
            }
            
            const duplicateGroups = findDuplicates();
            if (duplicateGroups.length === 0) {
                alert('–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–≤—Å–µ –∫—Ä–æ–º–µ –ø–µ—Ä–≤—ã—Ö –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ)
            const indicesToRemove = [];
            duplicateGroups.forEach(group => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å (–∏–Ω–¥–µ–∫—Å 0), –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
                for (let i = 1; i < group.records.length; i++) {
                    indicesToRemove.push(group.records[i].originalIndex);
                }
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é, —á—Ç–æ–±—ã —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —Å–±–∏–≤–∞–ª–æ –Ω—É–º–µ—Ä–∞—Ü–∏—é
            indicesToRemove.sort((a, b) => b - a);
            
            // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ globalData
            indicesToRemove.forEach(index => {
                globalData.splice(index, 1);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            rebuildTable();
            
            // –£–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            const duplicateControls = document.querySelector('.duplicate-controls');
            if (duplicateControls) {
                duplicateControls.remove();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
            const resultContainer = document.getElementById('resultContainer');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.innerHTML = `
                <strong>–î—É–±–ª–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã!</strong><br>
                –£–¥–∞–ª–µ–Ω–æ ${indicesToRemove.length} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π.<br>
                –û—Å—Ç–∞–ª–æ—Å—å ${globalData.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
            `;
            
            resultContainer.insertBefore(infoDiv, resultContainer.firstChild);
            
            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.parentNode.removeChild(infoDiv);
                }
            }, 5000);
        }
        
        function clearDuplicateHighlight() {
            document.querySelectorAll('.duplicate-row').forEach(row => {
                row.classList.remove('duplicate-row');
            });
            
            const duplicateControls = document.querySelector('.duplicate-controls');
            if (duplicateControls) {
                duplicateControls.remove();
            }
        }
        
        function rebuildTable() {
            if (globalData.length === 0) {
                document.getElementById('resultContainer').innerHTML = '<div class="info">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.</div>';
                document.getElementById('verifyBtn').disabled = true;
                document.getElementById('copyBtn').disabled = true;
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('duplicateBtn').disabled = true;
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let html = `<div class="stats">
                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${globalData.length} –∑–∞–ø–∏—Å–µ–π
            </div>`;
            
            html += '<div class="table-container">';
            html += `
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–î–æ–∫—É–º–µ–Ω—Ç</th>
                        <th>–§–∞–º–∏–ª–∏—è</th>
                        <th>–ò–º—è</th>
                        <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
                        <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è</th>
                        <th>–°–ú–û</th>
                        <th>–ï–ù–ü</th>
                        <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                        <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                        <th>–¢–∏–ø –ø–æ–ª–∏—Å–∞</th>
                        <th>–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞</th>
                        <th>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
            `;
            
            globalData.forEach((item, index) => {
                html += `
                    <tr id="row-${index}">
                        <td>${index + 1}</td>
                        <td>${formatDocument(item.docNumber, item.docType)}</td>
                        <td>${item.surname || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>'}</td>
                        <td>${item.firstName || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–æ</em>'}</td>
                        <td>${item.middleName || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–æ</em>'}</td>
                        <td>${item.birthDate || '<em>–Ω–µ —É–∫–∞–∑–∞–Ω–∞</em>'}</td>
                        <td class="status-column">${item.status || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'}</td>
                        <td class="ter-str-column">${item.ter_str || ''}</td>
                        <td class="smo-name-column">${item.smo_name || ''}</td>
                        <td class="enp-column">${item.enp || ''}</td>
                        <td class="date-begin-column">${item.date_begin || ''}</td>
                        <td class="date-close-column">${item.date_close || ''}</td>
                        <td class="policy-type-column">${item.policy_type || ''}</td>
                        <td class="policy-series-column">${item.policy_series_number || ''}</td>
                        <td class="attachments-column">${item.attachments || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                </tbody>
            </table>
            </div>
            `;
            
            document.getElementById('resultContainer').innerHTML = html;
        }
        
        function formatDocument(docNumber, docType) {
            if (docType === 1) {
                // –ü–∞—Å–ø–æ—Ä—Ç –†–§ - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –≤–∏–¥–µ xxxx xxxxxx (—Å–µ—Ä–∏—è + –Ω–æ–º–µ—Ä)
                if (docNumber.length === 10) {
                    return docNumber.substring(0, 4) + ' ' + docNumber.substring(4, 10);
                }
                return docNumber;
            } else if (docType === 3) {
                // –°–ù–ò–õ–° - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –≤–∏–¥–µ xxx-xxx-xxx xx
                if (docNumber.length === 11) {
                    return docNumber.substring(0, 3) + '-' + docNumber.substring(3, 6) + '-' + docNumber.substring(6, 9) + ' ' + docNumber.substring(9, 11);
                }
                return docNumber;
            } else if (docType === 4) {
                // –ï–ù–ü - –Ω–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                return docNumber;
            }
            return docNumber;
        }
        
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é
        function formatSnils(snils) {
            return formatDocument(snils, 3); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ —ç—Ç–æ –°–ù–ò–õ–°
        }
        
        async function verifyAllData() {
            if (globalData.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É');
                return;
            }
            
            verificationInProgress = true;
            currentVerificationIndex = 0;
            shouldStopVerification = false;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('verificationControls').style.display = 'block';
            document.getElementById('verifyBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            updateProgress(0);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            for (let i = 0; i < globalData.length && !shouldStopVerification; i++) {
                currentVerificationIndex = i;
                await verifyRecord(i);
                updateProgress((i + 1) / globalData.length * 100);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            finishVerification();
        }
        
        function verifyRecord(index) {
            return new Promise((resolve) => {
                const record = globalData[index];
                const statusCell = document.querySelector(`#row-${index} .status-column`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                statusCell.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...';
                statusCell.className = 'status-column status-checking';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º SOAP –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
                const soapMessage = buildSoapMessageForFed(
                    'ws_public', 
                    '296', 
                    record.surname || '', 
                    record.docNumber, 
                    record.docType.toString(), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –∑–∞–ø–∏—Å–∏
                    genUUIDv4()
                );
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const request = new Request({
                    url: 'https://ws.arhofoms.ru:55566/soap/people-search',
                    data: soapMessage,
                    onSuccess: function(result) {
                        const parsed = parseXmlResponse(result);
                        updateRecordWithResult(index, parsed);
                        resolve();
                    },
                    onError: function(msg) {
                        updateRecordWithResult(index, { error: "–û—à–∏–±–∫–∞: " + msg });
                        resolve();
                    },
                    onAbort: function() {
                        updateRecordWithResult(index, { error: "–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω" });
                        resolve();
                    }
                });
                
                request.go();
            });
        }
        
        function updateRecordWithResult(index, result) {
            const row = document.getElementById(`row-${index}`);
            if (!row) return;
            
            const statusCell = row.querySelector('.status-column');
            const terStrCell = row.querySelector('.ter-str-column');
            const smoNameCell = row.querySelector('.smo-name-column');
            const enpCell = row.querySelector('.enp-column');
            const dateBeginCell = row.querySelector('.date-begin-column');
            const dateCloseCell = row.querySelector('.date-close-column');
            const policyTypeCell = row.querySelector('.policy-type-column');
            const policySeriesCell = row.querySelector('.policy-series-column');
            const attachmentsCell = row.querySelector('.attachments-column');
            
            if (result.error) {
                statusCell.textContent = result.error;
                statusCell.className = 'status-column status-error';
            } else if (result.success) {
                statusCell.textContent = '–ù–∞–π–¥–µ–Ω';
                statusCell.className = 'status-column status-found';
                
                terStrCell.textContent = result.ter_str || '';
                smoNameCell.textContent = result.smo_name || '';
                enpCell.textContent = result.enp || '';
                dateBeginCell.textContent = result.date_begin || '';
                dateCloseCell.textContent = result.date_close || '';
                policyTypeCell.textContent = result.policy_type || '';
                policySeriesCell.textContent = result.policy_series_number || '';
                attachmentsCell.textContent = result.attachments || '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                globalData[index] = { ...globalData[index], ...result };
            } else {
                statusCell.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω';
                statusCell.className = 'status-column status-not-found';
            }
        }
        
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${currentVerificationIndex + 1} –∏–∑ ${globalData.length} (${Math.round(percent)}%)`;
        }
        
        function stopVerification() {
            shouldStopVerification = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('progressText').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏...';
        }
        
        function finishVerification() {
            verificationInProgress = false;
            document.getElementById('verifyBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (shouldStopVerification) {
                document.getElementById('progressText').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
            } else {
                document.getElementById('progressText').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            }
        }
        
        function exportToExcel() {
            if (globalData.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É.');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                const headers = [
                    '‚Ññ',
                    '–î–æ–∫—É–º–µ–Ω—Ç',
                    '–§–∞–º–∏–ª–∏—è',
                    '–ò–º—è',
                    '–û—Ç—á–µ—Å—Ç–≤–æ',
                    '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è',
                    '–°—Ç–∞—Ç—É—Å',
                    '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è',
                    '–°–ú–û',
                    '–ï–ù–ü',
                    '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                    '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                    '–¢–∏–ø –ø–æ–ª–∏—Å–∞',
                    '–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞',
                    '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ'
                ];
                
                // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                const exportData = [];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                exportData.push(headers);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                globalData.forEach((item, index) => {
                    const row = [
                        index + 1,
                        formatDocument(item.docNumber, item.docType),
                        item.surname || '',
                        item.firstName || '',
                        item.middleName || '',
                        item.birthDate || '',
                        item.status || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω',
                        item.ter_str || '',
                        item.smo_name || '',
                        item.enp || '',
                        item.date_begin || '',
                        item.date_close || '',
                        item.policy_type || '',
                        item.policy_series_number || '',
                        item.attachments || ''
                    ];
                    exportData.push(row);
                });
                
                // –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É
                const wb = XLSX.utils.book_new();
                
                // –°–æ–∑–¥–∞–µ–º –ª–∏—Å—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
                const colWidths = [
                    { wch: 5 },   // ‚Ññ
                    { wch: 15 },  // –î–æ–∫—É–º–µ–Ω—Ç
                    { wch: 20 },  // –§–∞–º–∏–ª–∏—è
                    { wch: 15 },  // –ò–º—è
                    { wch: 15 },  // –û—Ç—á–µ—Å—Ç–≤–æ
                    { wch: 12 },  // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                    { wch: 15 },  // –°—Ç–∞—Ç—É—Å
                    { wch: 25 },  // –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è
                    { wch: 30 },  // –°–ú–û
                    { wch: 20 },  // –ï–ù–ü
                    { wch: 12 },  // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                    { wch: 12 },  // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    { wch: 15 },  // –¢–∏–ø –ø–æ–ª–∏—Å–∞
                    { wch: 20 },  // –°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞
                    { wch: 40 }   // –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ
                ];
                ws['!cols'] = colWidths;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
                for (let col = 0; col < headers.length; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (ws[cellRef]) {
                        ws[cellRef].s = headerStyle;
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É
                XLSX.utils.book_append_sheet(wb, ws, "–î–∞–Ω–Ω—ã–µ –§–ï–†–ó");
                
                // –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // HH-MM-SS
                const filename = `ferz_data_${dateStr}_${timeStr}.xlsx`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
                XLSX.writeFile(wb, filename);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
                const exportBtn = document.getElementById('exportBtn');
                const originalText = exportBtn.textContent;
                exportBtn.textContent = '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!';
                exportBtn.style.backgroundColor = '#28a745';
                
                setTimeout(function() {
                    exportBtn.textContent = originalText;
                    exportBtn.style.backgroundColor = '#fd7e14';
                }, 3000);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const resultContainer = document.getElementById('resultContainer');
                const infoDiv = document.createElement('div');
                infoDiv.className = 'info';
                infoDiv.innerHTML = `
                    <strong>–§–∞–π–ª Excel —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</strong><br>
                    –ò–º—è —Ñ–∞–π–ª–∞: <strong>${filename}</strong><br>
                    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${globalData.length} –∑–∞–ø–∏—Å–µ–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.<br>
                    –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫ –±—Ä–∞—É–∑–µ—Ä–∞.
                `;
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                resultContainer.insertBefore(infoDiv, resultContainer.firstChild);
                
                // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
                setTimeout(function() {
                    if (infoDiv.parentNode) {
                        infoDiv.parentNode.removeChild(infoDiv);
                    }
                }, 7000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ Excel:', error);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX
                if (typeof XLSX === 'undefined') {
                    alert('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                } else {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message);
                }
            }
        }
        
        function copyTableData() {
            if (globalData.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É.');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                const headers = [
                    '‚Ññ',
                    '–î–æ–∫—É–º–µ–Ω—Ç',
                    '–§–∞–º–∏–ª–∏—è',
                    '–ò–º—è',
                    '–û—Ç—á–µ—Å—Ç–≤–æ',
                    '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è',
                    '–°—Ç–∞—Ç—É—Å',
                    '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è',
                    '–°–ú–û',
                    '–ï–ù–ü',
                    '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                    '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                    '–¢–∏–ø –ø–æ–ª–∏—Å–∞',
                    '–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞',
                    '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ'
                ];
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                const rows = [];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                rows.push(headers.join('\t'));
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                globalData.forEach((item, index) => {
                    const row = [
                        (index + 1).toString(),
                        formatDocument(item.docNumber, item.docType),
                        item.surname || '',
                        item.firstName || '',
                        item.middleName || '',
                        item.birthDate || '',
                        item.status || '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω',
                        item.ter_str || '',
                        item.smo_name || '',
                        item.enp || '',
                        item.date_begin || '',
                        item.date_close || '',
                        item.policy_type || '',
                        item.policy_series_number || '',
                        item.attachments || ''
                    ];
                    rows.push(row.join('\t'));
                });
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
                const tableText = rows.join('\n');
                
                // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(tableText).then(function() {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
                    const copyBtn = document.getElementById('copyBtn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    copyBtn.style.backgroundColor = '#28a745';
                    
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                        copyBtn.style.backgroundColor = '#17a2b8';
                    }, 2000);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    const resultContainer = document.getElementById('resultContainer');
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'info';
                    infoDiv.innerHTML = `
                        <strong>–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</strong><br>
                        –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ${globalData.length} –∑–∞–ø–∏—Å–µ–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.<br>
                        –í—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Excel, Google Sheets –∏–ª–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä.
                    `;
                    
                    // –í—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    resultContainer.insertBefore(infoDiv, resultContainer.firstChild);
                    
                    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(function() {
                        if (infoDiv.parentNode) {
                            infoDiv.parentNode.removeChild(infoDiv);
                        }
                    }, 5000);
                    
                }).catch(function(err) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                    
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = tableText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            alert('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                        } else {
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤—Ä—É—á–Ω—É—é.');
                        }
                    } catch (err) {
                        alert('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –í—ã–¥–µ–ª–∏—Ç–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤—Ä—É—á–Ω—É—é.');
                    }
                    
                    document.body.removeChild(textArea);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.');
            }
        }
        
        function clearAll() {
            document.getElementById('dataInput').value = '';
            document.getElementById('resultContainer').innerHTML = '';
            document.getElementById('verifyBtn').disabled = true;
            document.getElementById('copyBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('duplicateBtn').disabled = true;
            document.getElementById('verificationControls').style.display = 'none';
            globalData = [];
            verificationInProgress = false;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter + Ctrl –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        document.getElementById('dataInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                convertToTable();
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('dataInput').addEventListener('paste', function(e) {
            setTimeout(() => {
                const input = e.target.value.trim();
                if (input) {
                    document.getElementById('resultContainer').innerHTML = 
                        '<div class="info">–î–∞–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É" –∏–ª–∏ Ctrl+Enter –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.</div>';
                }
            }, 100);
        });
    </script>
</body>
</html>